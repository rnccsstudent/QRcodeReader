<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Decoder (Offline & Persistent)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="pako.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; max-width: 600px; margin: auto; }
    textarea, button { width: 100%; margin-top: 10px; padding: 10px; font-size: 16px; }
    button { cursor: pointer; }
    pre { background: #f4f4f4; padding: 10px; white-space: pre-wrap; word-wrap: break-word; }
    .small { font-size: 14px; color: gray; }
  </style>
</head>
<body>
  <h2>🔓 Paste QR Part (e.g. "1/3:base64...")</h2>
  <textarea id="input" placeholder="Paste each QR base64 part with header..."></textarea>
  <button onclick="savePart()">➕ Add This Part</button>
  <button onclick="clearAll()">🗑️ Clear All Parts</button>

  <div id="status" class="small"></div>

  <h2>🧩 Reassembled Output</h2>
  <pre id="output">Waiting for complete parts...</pre>
  <button onclick="copyText()">📋 Copy</button>
  <button onclick="downloadText()">⬇️ Download as .txt</button>

  <script>
    let parts = JSON.parse(localStorage.getItem('qr_parts') || '{}');

    function savePart() {
      const input = document.getElementById('input').value.trim();
      const match = input.match(/^(\d+)\/(\d+):(.+)$/);
      if (!match) {
        alert("Invalid format. Use: 1/3:base64...");
        return;
      }

      const [_, partNum, totalParts, base64] = match;
      parts[partNum] = base64;
      localStorage.setItem('qr_parts', JSON.stringify(parts));
      document.getElementById('input').value = '';
      updateStatus();
      tryAssemble(parseInt(totalParts));
    }

    function updateStatus() {
      const keys = Object.keys(parts).map(Number).sort((a,b)=>a-b);
      document.getElementById('status').textContent = `Saved Parts: ${keys.join(', ')}`;
    }

    function clearAll() {
      if (confirm("Clear all saved parts?")) {
        parts = {};
        localStorage.removeItem('qr_parts');
        document.getElementById('output').textContent = 'Waiting for complete parts...';
        updateStatus();
      }
    }

    function tryAssemble(total) {
      const collected = Object.keys(parts).length;
      if (collected < total) {
        document.getElementById('output').textContent = `Waiting for ${total - collected} more parts...`;
        return;
      }

      let joined = '';
      for (let i = 1; i <= total; i++) {
        if (!parts[i]) {
          document.getElementById('output').textContent = `Missing part ${i}`;
          return;
        }
        joined += parts[i];
      }

      try {
        const binary = atob(joined);
        const byteArray = Uint8Array.from(binary, c => c.charCodeAt(0));
        const original = pako.inflate(byteArray, { to: 'string' });
        document.getElementById('output').textContent = original;
      } catch (err) {
        document.getElementById('output').textContent = '❌ Error decoding: ' + err;
      }
    }

    function copyText() {
      const output = document.getElementById('output').textContent;
      navigator.clipboard.writeText(output).then(() => alert('✅ Copied to clipboard!'));
    }

    function downloadText() {
      const output = document.getElementById('output').textContent;
      const blob = new Blob([output], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'decoded.txt';
      a.click();
    }

    // On load
    updateStatus();
    const savedTotal = Math.max(...Object.keys(parts).map(Number), 0);
    if (savedTotal > 0) tryAssemble(savedTotal);
  </script>
</body>
</html>